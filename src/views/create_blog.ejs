<!-- views/create-blog.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create New Article - Bloggify</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    
    <!-- TinyMCE for Rich Text Editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.3/tinymce.min.js"></script>
    
    <style>
        .editor-container {
            max-width: 900px;
            margin: 2rem auto;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: #0d6efd;
        }
        .required-field::after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        .btn-save {
            background-color: #e9ecef;
            border-color: #dee2e6;
        }
        .btn-save:hover {
            background-color: #dee2e6;
            border-color: #ced4da;
        }
        .word-count {
            font-size: 0.875rem;
            color: #6c757d;
        }
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Navbar (using your existing navbar) -->
    <%- include('partials/navbar') %>

    <!-- Alert Container for Messages -->
    <div id="alert-container"></div>

    <div class="container editor-container">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <h1 class="mb-4">Create New Article</h1>
                
                <form id="blogForm" method="POST" action="/blogs">
                    <div class="mb-4">
                        <label for="title" class="form-label required-field">Title</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="title" 
                            name="title" 
                            required 
                            maxlength="200"
                            placeholder="Enter your article title"
                        >
                        <div class="word-count mt-1" id="titleCount">0/200 characters</div>
                    </div>

                    <div class="mb-4">
                        <label for="subtitle" class="form-label">Subtitle</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="subtitle" 
                            name="subtitle" 
                            maxlength="500"
                            placeholder="Enter a brief subtitle (optional)"
                        >
                        <div class="word-count mt-1" id="subtitleCount">0/500 characters</div>
                    </div>

                    <div class="mb-4">
                        <label for="content" class="form-label required-field">Content</label>
                        <textarea 
                            id="content" 
                            name="content" 
                            required
                            minlength="20"
                        ></textarea>
                    </div>

                    <div class="d-flex justify-content-end gap-3">
                        <button 
                            type="button" 
                            class="btn btn-save" 
                            onclick="saveDraft()"
                        >
                            <i class="fas fa-save me-2"></i>Save as Draft
                        </button>
                        <button 
                            type="submit" 
                            class="btn btn-primary" 
                            onclick="publishBlog(event)"
                        >
                            <i class="fas fa-paper-plane me-2"></i>Publish
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize TinyMCE
        tinymce.init({
            selector: '#content',
            height: 500,
            menubar: false,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | blocks | ' +
                'bold italic | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; font-size: 16px }'
        });

        // Character count for title and subtitle
        document.getElementById('title').addEventListener('input', function() {
            document.getElementById('titleCount').textContent = 
                `${this.value.length}/200 characters`;
        });

        document.getElementById('subtitle').addEventListener('input', function() {
            document.getElementById('subtitleCount').textContent = 
                `${this.value.length}/500 characters`;
        });

        // Show alert function
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Save as draft
        async function saveDraft() {
            const title = document.getElementById('title').value;
            const subtitle = document.getElementById('subtitle').value;
            const content = tinymce.get('content').getContent();

            try {
                const response = await fetch('/blogs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        subtitle,
                        content,
                        status: 'draft'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Draft saved successfully!');
                } else {
                    throw new Error(data.message || 'Failed to save draft');
                }
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }

        // Publish blog
        async function publishBlog(event) {
            event.preventDefault();
            
            const title = document.getElementById('title').value;
            const subtitle = document.getElementById('subtitle').value;
            const content = tinymce.get('content').getContent();

            if (!title || !content || content.length < 20) {
                showAlert('Please fill in all required fields', 'danger');
                return;
            }

            try {
                const response = await fetch('/blogs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        subtitle,
                        content,
                        status: 'published'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showAlert('Blog published successfully!');
                    // Redirect to the published blog after 1 second
                    setTimeout(() => {
                        window.location.href = `/blogs/${data.blog.slug}`;
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Failed to publish blog');
                }
            } catch (error) {
                showAlert(error.message, 'danger');
            }
        }
    </script>
</body>
</html>